# 3rd party
import pathlib
import traceback
from typing import List, Optional
import numpy as np
from skimage.feature import peak_local_max

# Our own imports
from multilineage_organoid import signals as sg
from multilineage_organoid.io import DataReader
from multilineage_organoid.utils import *

SIGNAL_TYPE = 'F/F0'  # F-F0, F/F0, F-F0/F0

LINEAR_MODEL = 'ransac'  # 'least_squares' or 'ransac' or 'exp_ransac'

DATA_TYPE = 'ephys'  # one of 'ca', 'ephys'

FILTER_ORDER = 1  # Order of the butterworth filter
FILTER_CUTOFF = 4  # Hz cutoff for the filter
MIN_STATS_SCORE = 0.2  # Cutoff for peaks to be sufficiently wavy

FIGSIZE = 8  # inches - the width of a (square) figure panel

PLOT_SUFFIX = '.png'

SAMPLES_AROUND_PEAK = 10  # Minimum number of samples around a peak before the next peak can start

TIME_SCALE = 1000  # milliseconds / second

DEBUG_OPTIMIZER = True  # If True, print optimizer debug messages

debug_raw_data = [124.07531380753100,123.99648535564900,123.97807531380800,123.95966527196700,123.82945606694600,123.72535564853600,123.64468619246900,123.5949790794980,123.56066945606700,123.49071129707100,123.4344769874480,123.3241841004180,123.20016736401700,123.2376569037660,123.10359832636000,123.138410041841,123.25757322175700,124.51916317991600,125.5434309623430,126.08217573221800,126.43966527196700,126.94025104602500,127.10041841004200,127.3236820083680,127.50728033472800,127.58861924686200,127.6813389121340,127.7236820083680,127.69255230125500,127.61271966527200,127.62778242677800,127.61221757322200,127.48267782426800,127.41037656903800,127.28351464435100,127.22276150627600,127.13857740585800,126.97974895397500,126.95012552301300,126.8450209205020,126.72301255230100,126.63966527196700,126.4915481171550,126.36769874477000,126.2905439330540,126.19096234309600,126.02811715481200,125.93824267782400,125.83832635983300,125.73991631799200,125.57807531380800,125.48836820083700,125.39246861924700,125.2855230125520,125.19765690376600,125.09338912133900,125.01891213389100,124.90326359832600,124.79012552301300,124.6855230125520,124.58828451882800,124.48619246861900,124.40569037656900,124.31698744769900,124.26092050209200,124.11715481171500,124.10610878661100,124.02728033472800,123.92301255230100,123.80150627615100,123.82225941422600,123.75765690376600,123.60987447698700,123.58661087866100,123.47799163179900,123.45054393305400,123.39464435146400,123.27748953974900,123.25573221757300,123.17271966527200,123.12066945606700,123.0326359832640,123.02326359832600,123.70861924686200,124.92485355648500,125.6276150627620,126.22092050209200,126.50326359832600,126.83514644351500,127.10443514644400,127.34092050209200,127.47548117154800,127.52753138075300,127.61539748954000,127.58811715481200,127.60200836820100,127.58560669456100,127.5181589958160,127.49121338912100,127.41924686192500,127.3094560669460,127.20418410041800,127.13958158995800,126.99380753138100,126.9889539748950,126.81690376569000,126.72970711297100,126.63347280334700,126.51916317991600,126.36033472803300,126.30041841004200,126.14460251046000,126.04803347280300,125.94794979079500,125.79682008368200,125.74476987447700,125.6239330543930,125.50058577405900,125.35213389121300,125.23112970711300,125.21824267782400,125.10443514644400,124.9650209205020,124.84518828451900,124.79832635983300,124.64451882845200,124.5636820083680,124.48451882845200,124.40619246861900,124.24351464435100,124.15230125523000,124.10410041841000,124.00686192468600,123.93020920502100,123.88033472803300,123.74845188284500,123.71765690376600,123.65757322175700,123.54075313807500,123.51146443514600,123.4726359832640,123.38493723849400,123.39313807531400,123.22376569037700,123.17623430962300,123.10928870292900,123.05171548117200,123.05004184100400,122.9820920502090,123.10326359832600,124.14594142259400,125.14560669456100,125.73305439330500,126.13723849372400,126.52100418410000,126.77807531380800,127.01037656903800,127.1618410041840,127.29874476987400,127.36167364016700,127.38861924686200,127.41690376569000,127.38811715481200,127.41539748954000,127.31648535564900,127.18008368200800,127.13673640167400,127.03548117154800,126.91748953974900,126.84401673640200,126.78510460251000,126.66627615062800,126.5834309623430,126.4818410041840,126.3052719665270,126.2528870292890,126.1539748953980,126.01489539749000,125.92401673640200,125.82928870292900,125.64652719665300,125.56953974895400,125.51179916318000,125.33874476987400,125.2547280334730,125.14510460251000,125.04769874477000,124.96803347280300,124.8455230125520,124.82225941422600,124.63732217573200,124.58627615062800,124.48585774058600,124.37757322175700,124.3250209205020,124.20435146443500,124.10225941422600,124.01355648535600,123.92853556485400,123.85255230125500,123.83364016736400,123.7668619246860,123.63481171548100,123.57171548117200,123.51163179916300,123.42092050209200,123.31096234309600,123.23548117154800,123.21556485355600,123.15246861924700,123.06778242677800,123.0639330543930,122.92502092050200,122.89774058577400,122.84468619246900,122.7802510460250,123.36384937238500,124.56401673640200,125.28401673640200,125.75029288702900,126.19380753138100,126.50242677824300,126.74610878661100,126.94175732217600,127.07380753138100,127.15364016736400,127.18861924686200,127.2018410041840,127.17874476987400,127.16066945606700,127.07414225941400,127.02728033472800,126.935230125523,126.83481171548100,126.82108786610900,126.76669456066900,126.55832635983300,126.4528870292890,126.39364016736400,126.30979079497900,126.14008368200800,126.03330543933100,126.01723849372400,125.87146443514600,125.80133891213400,125.63715481171500,125.55514644351500,125.45891213389100,125.38560669456100,125.22242677824300,125.11983263598300,124.96401673640200,124.92635983263600,124.79849372384900,124.66242677824300,124.62728033472800,124.50460251046000,124.41774058577400,124.35933054393300,124.1963179916320,124.10108786610900,124.05004184100400,123.97037656903800,123.85623430962300,123.8165690376570,123.68100418410000,123.66610878661100,123.56786610878700,123.4707949790800,123.47866108786600,123.33439330543900,123.31698744769900,123.21958158995800,123.15079497907900,123.0744769874480,123.00987447698700,122.97740585774100,122.85439330543900,122.8363179916320,122.80150627615100,122.70661087866100,122.60585774058600,122.74627615062800,123.73037656903800,124.77171548117200,125.31882845188300,125.79280334728000,126.1655230125520,126.40970711297100,126.65991631799200,126.77640167364000,126.93372384937200,126.9655230125520,127.02912133891200,127.07347280334700,126.95146443514600,126.95648535564900,126.86560669456100,126.86895397489500,126.75933054393300]

def debug_calc_signal_stats(time: np.ndarray,
                      signals: np.ndarray,
                      time_scale: float = TIME_SCALE,
                      samples_around_peak: int = SAMPLES_AROUND_PEAK,
                      skip_model_fit: bool = False) -> Tuple[List]:
    """ Calculate useful stats for a set of signals

    :param ndarray time:
        The n x 1 time array
    :param ndarray signals:
        The n x m signal array
    :param float time_scale:
        The conversion of time to seconds
    :param int samples_around_peak:
        Minimum number of samples around a peak before the next peak
    :returns:
        The list of valid signal indicies and the list of stats for each peak found in the signal array
    """

    all_peaks = []
    valid_signal_indicies = []

    for i in range(signals.shape[1]):
        signal = signals[:, i]

        # Mask out invalid values
        sigmask = np.isfinite(signal)
        if not np.any(sigmask):
            print(f'Empty signal in sample: {i}')
            continue

        # Mask out signals with discontinuities
        offset_st, offset_ed = np.nonzero(sigmask)[0][[0, -1]]
        if not np.all(sigmask[offset_st:offset_ed+1]):
            invalid_indices = np.nonzero(~sigmask[offset_st:offset_ed+1])
            print(f'Non-contiguous signal in sample {i}: {invalid_indices}')
            continue

        signal_finite = signal[sigmask]
        time_finite = time[sigmask]

        peak_indicies = peak_local_max(signal_finite,
                                       min_distance=samples_around_peak)

        peaks = sg.refine_signal_peaks(time_finite, signal_finite, peak_indicies,
                                    offset=offset_st,
                                    time_scale=time_scale,
                                    skip_model_fit=skip_model_fit)

        all_peaks.append(peaks)
        valid_signal_indicies.append(i)
    return valid_signal_indicies, all_peaks

def debug_filter_datafile(
                    infile: pathlib.Path = pathlib.Path("D:\Work\multilineage-organoid\\tests\\debug_data.csv"),
                    data_type: str = DATA_TYPE,
                    signal_type: str = SIGNAL_TYPE,
                    filter_cutoff: float = FILTER_CUTOFF,
                    filter_order: float = FILTER_ORDER,
                    plot_types: Optional[List[str]] = None,
                    time_scale: float = TIME_SCALE,
                    skip_detrend: bool = False,
                    skip_lowpass: bool = False,
                    skip_model_fit: bool = False,
                    samples_around_peak: int = SAMPLES_AROUND_PEAK,
                    flip_signal: bool = False,
                    level_shift: Optional[str] = None,
                    plotfile: Optional[pathlib.Path] = None,
                    linear_model: str = LINEAR_MODEL):
    try:
        time, raw_signals = DataReader(data_type).read_infile(
            infile, flip_signal=flip_signal, level_shift=level_shift)
    except OSError as err:
        print(f'Error {err} reading "{infile}"')
        if DEBUG_OPTIMIZER:
            traceback.print_exc()
        return None

    dt = np.nanmedian(time[1:] - time[:-1]) / time_scale  # Seconds
    sample_rate = 1.0 / dt

    signals, trend_lines = sg.remove_trend(raw_signals,
                                        signal_type=signal_type,
                                        skip_detrend=skip_detrend,
                                        linear_model=linear_model)
    if not skip_lowpass:
        signals = lowpass_filter(signals,
                                 sample_rate=sample_rate,
                                 cutoff=filter_cutoff,
                                 order=filter_order)
        
    signal_indicies, stats = debug_calc_signal_stats(time, signals,
                                               time_scale=time_scale,
                                               samples_around_peak=samples_around_peak,
                                               skip_model_fit=skip_model_fit)
    print(signal_indicies)
    print(stats)

    raw_signals = raw_signals[:, signal_indicies]
    signals = signals[:, signal_indicies]

    stats = sg.select_top_stats(stats)
    stats = sg.add_summary_stats(stats, time_scale=time_scale)

    print(stats)

debug_filter_datafile(skip_detrend = True, skip_lowpass=True)
